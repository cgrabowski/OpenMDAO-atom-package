// Generated by CoffeeScript 1.4.0
(function() {
  var SysHierarchyChart,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.SysHierarchyChart = SysHierarchyChart = (function() {

    SysHierarchyChart.prototype.defaults = {
      container: null,
      minElementHeight: 40,
      collapsedSizePixels: 10,
      transitionDuration: 500,
      rootElementMaxFontSize: 32,
      minFontSize: 14,
      colors: {
        root: 'rgb(240, 190, 190)',
        group: 'rgb(240, 180, 180)',
        component: 'rgb(180, 180, 240)',
        variable: 'rgb(210, 210, 225)',
        state: 'rgb(210, 240, 180)'
      }
    };

    SysHierarchyChart.prototype.removeParentNamesRegex = /\w*$/;

    SysHierarchyChart.prototype.elipsisRegex = /\.\.\.$/;

    function SysHierarchyChart(data, config) {
      var closeHelpButton, datum, getLow, helpDiv, helpIconElements, i, jsonLowestPlainObjs, key, partition, prop, self, setRowOrder, val, _i, _j, _len, _ref, _ref1, _ref2,
        _this = this;
      this.data = data;
      this.config = config != null ? config : {};
      this.setAllRowPositions = __bind(this.setAllRowPositions, this);

      this.setExpandingDx = __bind(this.setExpandingDx, this);

      this.resize = __bind(this.resize, this);

      this.collapse = __bind(this.collapse, this);

      this.zoom = __bind(this.zoom, this);

      self = this;
      _ref = this.defaults;
      for (prop in _ref) {
        val = _ref[prop];
        if (this.config[prop] == null) {
          this.config[prop] = val;
        }
      }
      if (this.config.container != null) {
        this.container = this.config.container;
      } else {
        this.container = document.createElement('div');
        document.body.appendChild(this.container);
      }
      this.chartWidth = parseInt(window.getComputedStyle(this.container).width);
      this.chartHeight = window.innerHeight - 20;
      this.rangeX = d3.scale.linear().range([0, this.chartWidth]);
      this.rangeY = d3.scale.linear().range([0, this.chartHeight]);
      this.svg = d3.select(this.container).append('svg').attr('width', this.chartWidth).attr('height', this.chartHeight);
      partition = d3.layout.partition().children(function(datum) {
        var vals;
        vals = d3.entries(datum.value);
        vals.forEach(function(ele, i, arr) {
          return ele.siblingOrder = i;
        });
        return vals.filter(function(datum, i, arr) {
          return datum.value.constructor.name === 'Object';
        });
      }).sort(function(a, b) {
        return a.siblingOrder - b.siblingOrder;
      }).value(function(datum) {
        return 1;
      });
      this.groups = this.svg.selectAll('g').data(partition(d3.entries(this.data.systemHierarchy)[0])).enter().append('g').each(function(datum) {
        datum.element = this;
        return datum.chart = self;
      }).attr('x', this.deltaX).attr('y', this.deltaY).attr('width', this.deltaWidth).attr('height', this.deltaHeight).each(function(datum) {
        if (datum.parent == null) {
          return _this.rootDatum = datum;
        }
      });
      jsonLowestPlainObjs = (getLow = function(data, keyin, out) {
        var hasChildObj, key;
        hasChildObj = false;
        for (key in data) {
          val = data[key];
          if (val.constructor.name === 'Object') {
            out = getLow(val, key, out);
            hasChildObj = true;
          }
        }
        if (!hasChildObj) {
          out[keyin] = data;
        }
        return out;
      })(data, 'root', {});
      _ref1 = this.getDataLeaves();
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        datum = _ref1[_i];
        for (key in jsonLowestPlainObjs[datum.key]) {
          datum[key] = jsonLowestPlainObjs[datum.key][key];
        }
      }
      this.rects = this.groups.append('rect').attr('x', this.deltaX).attr('y', this.deltaY).attr('width', this.deltaWidth).attr('height', this.deltaHeight).attr('fill', function(datum) {
        var child, type, _j, _len1, _ref2;
        type = 'group';
        if (datum.depth === 0) {
          type = 'root';
        }
        if ((datum.children != null) && !(datum.children[0].children != null)) {
          type = 'component';
        }
        if (!(datum.children != null)) {
          type = 'variable';
        }
        if (datum.state != null) {
          type = 'state';
        }
        if (datum.children != null) {
          _ref2 = datum.children;
          for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
            child = _ref2[_j];
            if (child.state != null) {
              type = 'state';
            }
          }
        }
        return _this.config.colors[type];
      });
      this.titles = this.groups.append('title');
      this.texts = this.groups.append('text').attr('font-size', this.deltaText).text(function(datum) {
        return _this.removeParentNamesRegex.exec(datum.key);
      }).attr('x', this.deltaX).attr('y', this.deltaY).each(this.handleTextAndTooltips);
      (setRowOrder = function(depth) {
        var ele, i, row, _j, _len1, _ref2;
        if ((row = _this.getDataByDepth(depth)).length !== 0) {
          _ref2 = row.sort(function(a, b) {
            return a.x - b.x;
          });
          for (i = _j = 0, _len1 = _ref2.length; _j < _len1; i = ++_j) {
            ele = _ref2[i];
            ele.rowOrder = i;
          }
          return setRowOrder(++depth);
        }
      })(1);
      this.groups.on('focus', function(datum) {
        return _this.focusedDatum = datum;
      });
      window.addEventListener('resize', this.resize);
      helpIconElements = document.getElementsByClassName('help-icon');
      helpDiv = document.getElementById('help');
      closeHelpButton = document.getElementById('close-help-button');
      for (i = _j = 0, _ref2 = helpIconElements.length - 1; 0 <= _ref2 ? _j <= _ref2 : _j >= _ref2; i = 0 <= _ref2 ? ++_j : --_j) {
        helpIconElements.item(i).addEventListener('click', function(event) {
          var ii, _k, _ref3;
          helpDiv.style.display = 'inline-block';
          for (ii = _k = 0, _ref3 = helpIconElements.length - 1; 0 <= _ref3 ? _k <= _ref3 : _k >= _ref3; ii = 0 <= _ref3 ? ++_k : --_k) {
            helpIconElements.item(ii).style.display = 'none';
          }
          return false;
        });
      }
      closeHelpButton.addEventListener('click', function(event) {
        var _k, _ref3;
        for (i = _k = 0, _ref3 = helpIconElements.length - 1; 0 <= _ref3 ? _k <= _ref3 : _k >= _ref3; i = 0 <= _ref3 ? ++_k : --_k) {
          helpIconElements.item(i).style.display = 'block';
        }
        helpDiv.style.display = 'none';
        return false;
      });
    }

    SysHierarchyChart.prototype.getDataByDepth = function(depth) {
      var data;
      data = [];
      this.svg.selectAll('g').each(function(datum) {
        if (datum.depth === depth) {
          return data.push(datum);
        }
      });
      return data;
    };

    SysHierarchyChart.prototype.getDataLeaves = function(datum) {
      var leaves, selection;
      if (datum == null) {
        datum = this.rootDatum;
      }
      leaves = [];
      selection = datum === this.rootDatum ? this.svg.selectAll('g') : this.datumDescendantElements(d3.select(datum.element), datum.filter(function(d) {
        return this.nodeName === 'g';
      }));
      selection.each(function(d) {
        if (d.children == null) {
          return leaves.push(d);
        }
      });
      return leaves;
    };

    SysHierarchyChart.prototype.addDatumChildrenElements = function(selection, datum) {
      var child, children, _i, _len;
      children = datum.element.children;
      for (_i = 0, _len = children.length; _i < _len; _i++) {
        child = children[_i];
        if (children != null) {
          selection[0].push(child);
        }
      }
      return selection;
    };

    SysHierarchyChart.prototype.addDatumAncestorElements = function(selection, datum) {
      while ((datum = datum.parent) != null) {
        selection[0].push(datum.parent.element);
      }
      return selection;
    };

    SysHierarchyChart.prototype.addDatumDescendantElements = function(selection, datum) {
      var pushDatum;
      (pushDatum = function(d) {
        var child, _i, _len, _ref, _results;
        if (d.children != null) {
          _ref = d.children;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            child = _ref[_i];
            selection[0].push(child.element);
            _results.push(pushDatum(selection, child));
          }
          return _results;
        }
      })(datum);
      return selection;
    };

    SysHierarchyChart.prototype.addDatumSiblingElements = function(selection, datum) {
      var child, _i, _len, _ref, _results;
      _ref = datum.parent.children;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        if (datum.parent != null) {
          if (child.element !== datum.element) {
            _results.push(selection[0].push(child.element));
          } else {
            _results.push(void 0);
          }
        }
      }
      return _results;
    };

    SysHierarchyChart.prototype.zoom = function(datum) {
      console.log('zoom');
      this.rangeX.domain([datum.x, datum.x + datum.dx]);
      this.rangeY.domain([datum.y, 1]).range([datum.y === 0 ? 0 : 20, this.chartHeight]);
      return this.transitionAll();
    };

    SysHierarchyChart.prototype.collapse = function(datum) {
      var c, child, collapsing, cw, d, i, numNotCollapsed, stateVar, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2,
        _this = this;
      if (datum === this.rootDatum) {
        return;
      }
      cw = this.chartWidth;
      numNotCollapsed = (this.getDataByDepth(datum.depth).filter(function(d, i, arr) {
        return !_this.isCollapsed(d.element);
      })).length;
      if (numNotCollapsed === 1) {
        return;
      }
      collapsing = this.addDatumDescendantElements(d3.select(datum.element), datum);
      collapsing.each(function(d) {
        var parent;
        datum.element.classList.add('collapsed');
        if (_this.nodeName === 'text') {
          _this.style.visibility = 'hidden';
        }
        d.dx = 0;
        parent = d;
        while (_this.isCollapsed(parent.element)) {
          parent.dx = _this.config.collapsedSizePixels / _this.chartWidth;
          parent = parent.parent;
        }
        return d.x = datum.x;
      });
      child = datum;
      while (child.children != null) {
        stateVar = null;
        _ref = child.children;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          c = _ref[i];
          if (c.state != null) {
            stateVar = c;
            stateVar.dx = this.config.collapsedSizePixels / cw;
            break;
          }
        }
        _ref1 = child.children;
        for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
          c = _ref1[i];
          if (stateVar === null && i === 0) {
            c.dx = this.config.collapsedSizePixels / cw;
          } else if (stateVar !== d) {
            c.dx = 0;
            _ref2 = this.addDatumDescendantElements(d3.select(c.element), c);
            for (i = _k = 0, _len2 = _ref2.length; _k < _len2; i = ++_k) {
              d = _ref2[i];
              d.dx = 0;
            }
          }
        }
        child = child.children[0];
      }
      this.setExpandingDx();
      this.setAllRowPositions();
      return this.transitionAll();
    };

    SysHierarchyChart.prototype.expand = function(datum) {
      var rootExpansionDatum, selection, traverseAncestors,
        _this = this;
      selection = d3.select(datum.element);
      this.datumChildrenElements(selection, datum);
      this.datumDescendantElements(selection, datum);
      selection.classed('collapsed', false);
      rootExpansionDatum = (traverseAncestors = function(d) {
        var dd, numExpandedChildren, parent, parentSelection, _i, _len, _ref;
        parent = d.parent;
        parentSelection = d3.select(parent.element);
        if (!_this.isCollapsed(parentSelection)) {
          return d;
        }
        parentSelection.classed('collapsed', false);
        numExpandedChildren = (parent.children.filter(function(dd, i, arr) {
          return !_this.isCollapsed(dd.element);
        })).length;
        if (numExpandedChildren === 1) {
          _ref = parent.children;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            dd = _ref[_i];
            _this.datumDescendantElements(d3.select(dd.element), dd).classed('collapsed', false);
          }
        }
        return traverseAncestors(parent);
      })(datum);
      this.setExpandingDx();
      this.setAllRowPositions();
      this.transitionAll();
      return rootExpansionDatum;
    };

    SysHierarchyChart.prototype.transitionAll = function(duration) {
      if (duration == null) {
        duration = this.config.transitionDuration;
      }
      return this.svg.selectAll('g, rect, text').transition().duration(duration).attr('x', this.deltaX).attr('y', this.deltaY).attr('width', this.deltaWidth).attr('height', this.deltaHeight).filter(function(datum) {
        return datum.element.nodeName === 'text';
      }).attr('font-size', this.deltaText).each('end', this.handleTextAndTooltips);
    };

    SysHierarchyChart.prototype.resize = function() {
      var _this = this;
      this.chartWidth = parseInt(window.getComputedStyle(this.container).width);
      this.chartHeight = window.innerHeight - 20;
      this.svg.attr('width', this.chartWidth);
      this.svg.attr('height', this.chartHeight);
      this.rangeX.range([0, this.chartWidth]);
      this.rangeY.range([0, this.chartHeight]);
      this.svg.selectAll('.collapsed').each(function(d) {
        d.dx = d.dx === 0 ? 0 : _this.config.collapsedSizePixels / _this.chartWidth;
        return _this.deltaWidth(datum);
      });
      this.setExpandingDx();
      this.setAllRowPositions();
      return this.transitionAll(10);
    };

    SysHierarchyChart.prototype.isCollapsed = function(element) {
      return element.classList.contains('collapsed');
    };

    SysHierarchyChart.prototype.setExpandingDx = function() {
      var datum, expanding, findCollapsed, i, leaf, leafdx, leaves, lvs, numCollapsed, numCollapsedAreas, numExpanded, numExpandedLeaves, unCollapsedArea, _i, _j, _len, _len1,
        _this = this;
      expanding = this.svg.selectAll('g').filter(function(d) {
        return !_this.isCollapsed(d.element);
      });
      leaves = this.getDataLeaves();
      numExpandedLeaves = 0;
      numCollapsedAreas = 0;
      for (i = _i = 0, _len = leaves.length; _i < _len; i = ++_i) {
        leaf = leaves[i];
        if (this.isCollapsed(leaf.element)) {
          if (leaf.dx === 0) {
            numExpandedLeaves += 1;
          } else {
            numCollapsedAreas += 1;
          }
        }
      }
      unCollapsedArea = this.chartWidth - numCollapsedAreas * this.config.COLLAPSED_SIZE_PIXELS;
      leafdx = 1 / numExpandedLeaves * unCollapsedArea / this.chartWidth;
      for (_j = 0, _len1 = expanding.length; _j < _len1; _j++) {
        datum = expanding[_j];
        if (datum.parent == null) {
          return;
        }
        lvs = this.getDataLeaves(datum);
        numExpanded = (lvs.filter(function(d, i, arr) {
          return !this.isCollapsed(d.element);
        })).length;
        numCollapsed = 0;
        (findCollapsed = function(d) {
          var child, children, _k, _len2, _results;
          if (!(children = d.children != null)) {
            return;
          }
          _results = [];
          for (_k = 0, _len2 = children.length; _k < _len2; _k++) {
            child = children[_k];
            if (_this.isCollapsed(child.element)) {
              _results.push(++numCollapsed);
            } else {
              _results.push(findCollapsed(child));
            }
          }
          return _results;
        })(d);
        datum.dx = leafdx * numExpandedLeaves + numCollapsedAreas * this.config.COLLAPSED_SIZE_PIXELS / this.chartWidth;
      }
    };

    SysHierarchyChart.prototype.setAllRowPositions = function() {
      var _this = this;
      this.groups.each(function(datum) {
        var i, laterals, _i, _ref, _results;
        if (datum.parent == null) {
          return;
        }
        laterals = _this.getDataByDepth(datum.depth);
        datum.newX = 0;
        if (laterals.indexOf(datum) !== 0) {
          _results = [];
          for (i = _i = 0, _ref = laterals.indexOf(datum) - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
            _results.push(datum.newX += laterals[i].dx);
          }
          return _results;
        }
      });
      return this.groups.each(function(datum) {
        if (datum.parent == null) {
          return;
        }
        datum.x = datum.newX;
        return delete datum.newX;
      });
    };

    SysHierarchyChart.prototype.deltaX = function(datum) {
      var chart;
      chart = datum.chart;
      if (this.nodeName === 'text') {
        return chart.rangeX(datum.x) + chart.deltaWidth(datum) / 2 - this.getBBox().width / 2;
      } else {
        return chart.rangeX(datum.x);
      }
    };

    SysHierarchyChart.prototype.deltaY = function(datum) {
      var chart;
      chart = datum.chart;
      if (this.nodeName === 'text') {
        return chart.rangeY(datum.y) + this.getBBox().height;
      } else {
        return chart.rangeY(datum.y);
      }
    };

    SysHierarchyChart.prototype.deltaWidth = function(datum) {
      var chart;
      chart = datum.chart;
      return chart.rangeX(datum.x + datum.dx) - chart.rangeX(datum.x);
    };

    SysHierarchyChart.prototype.deltaHeight = function(datum) {
      var chart;
      chart = datum.chart;
      return chart.rangeY(datum.y + datum.dy) - chart.rangeY(datum.y);
    };

    SysHierarchyChart.prototype.deltaText = function(datum) {
      var calcedSize, config, height, rootFontSize, rootRect;
      config = datum.chart.config;
      rootRect = datum.chart.rootDatum.element.getElementsByTagName('rect')[0];
      height = parseInt(rootRect.getAttribute('height'));
      rootFontSize = height * 0.8 > config.rootElementMaxFontSize ? config.rootElementMaxFontSize : height * 0.8;
      calcedSize = rootFontSize - 0.15 * rootFontSize * datum.depth;
      if (calcedSize > config.minFontSize) {
        return calcedSize;
      } else {
        return config.minFontSize;
      }
    };

    SysHierarchyChart.prototype.handleTextAndTooltips = function(datum) {
      var chart, child, ele, gw, i, pw, px, siblings, textLength, tooltip, tw, _i, _j, _ref, _ref1;
      chart = datum.chart;
      ele = null;
      for (i = _i = 0, _ref = datum.element.childNodes.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        child = datum.element.childNodes.item(i);
        if (child.nodeName === 'text') {
          ele = child;
        }
      }
      ele.innerHTML = chart.removeParentNamesRegex.exec(datum.key);
      gw = ele.parentNode.getAttribute('width');
      tw = ele.getBBox().width;
      siblings = ele.parentNode.childNodes;
      tooltip = null;
      for (i = _j = 0, _ref1 = siblings.length - 1; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; i = 0 <= _ref1 ? ++_j : --_j) {
        if (siblings.item(i).nodeName === 'title') {
          tooltip = siblings.item(i);
        }
      }
      if (tw > gw - 10) {
        if (chart.isCollapsed(ele.parentNode)) {
          ele.style.visiblity = 'hidden';
          return tooltip.innerHTML = 'datum.key';
        } else {
          ele.style.visiblity = 'visible';
          tooltip.innerHTML = '';
          if (!chart.elipsisRegex.test(ele.innerHTML)) {
            this.innerHTML += '...';
          }
          textLength = ele.innerHTML.length - 3;
          while (ele.getBBox().width > parseInt(ele.parentNode.getAttribute('width')) - 10) {
            if (textLength < 1) {
              ele.innerHTML = '...';
              break;
            } else {
              ele.innerHTML = ele.innerHTML.substr(0, --textLength) + '...';
            }
          }
          if (ele.innerHTML.length < 3) {
            ele.innerHTML = '';
          }
          px = parseInt(ele.parentNode.getAttribute('x'));
          pw = parseInt(ele.parentNode.getAttribute('width'));
          tw = ele.getBBox().width;
          return ele.setAttribute('x', px + (pw / 2 - tw / 2));
        }
      } else {
        if (chart.isCollapsed(ele.parentNode)) {
          ele.style.visibility = 'hidden';
          tooltip.innerHTML = datum.key;
        } else {
          ele.style.visibility = 'visible';
          tooltip.innerHTML = '';
        }
        if (chart.elipsisRegex.test(ele.innerHTML)) {
          ele.innerHTML = chart.removeParentNamesRegex.exec(datum.key);
        }
        px = parseInt(ele.parentNode.getAttribute('x'));
        pw = parseInt(ele.parentNode.getAttribute('width'));
        tw = ele.getBBox().width;
        return ele.setAttribute('x', px + (pw / 2 - tw / 2));
      }
    };

    return SysHierarchyChart;

  })();

}).call(this);
